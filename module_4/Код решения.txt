WITH winter_anapa as
(SELECT *
FROM dst_project.flights
WHERE departure_airport = 'AAQ'
  AND (date_trunc('month', scheduled_departure) in ('2017-01-01','2017-02-01', '2017-12-01'))
  AND status not in ('Cancelled')

)
SELECT *
FROM


    (SELECT w_a.flight_id,
              w_a.departure_airport,
              a.city departure_city ,
              date_part('hour', w_a.actual_arrival-w_a.actual_departure)*60+date_part('minute', w_a.actual_arrival-w_a.actual_departure) minutes_in_air
       FROM winter_anapa w_a 
            JOIN dst_project.airports a ON w_a.departure_airport=a.airport_code
            ) departed
            
     join
    
    (SELECT w_a.flight_id,
              w_a.arrival_airport,
              a.city arrival_city
       FROM winter_anapa w_a 
            JOIN dst_project.airports a ON w_a.departure_airport=a.airport_code
            ) arrived
    on departed.flight_id=arrived.flight_id