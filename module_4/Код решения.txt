WITH winter_anapa AS
  (SELECT *
   FROM dst_project.flights
   WHERE departure_airport = 'AAQ'
     AND (date_trunc('month', scheduled_departure) in ('2017-01-01',
                                                       '2017-02-01',
                                                       '2017-12-01'))
     AND status not in ('Cancelled') ),
     */Список расхода топлива для каждого самолета, кроме Cessna 208 (не нашел)*/
     fuel_consumption AS
  (SELECT '773' AS aircraft_code,
          '2600' AS consmp_per_hour
   UNION SELECT '763' AS aircraft_code,
                '4500' AS consmp_per_hour
   UNION SELECT 'SU9' AS aircraft_code,
                '1800' AS consmp_per_hour
   UNION SELECT '320' AS aircraft_code,
                '2700' AS consmp_per_hour
   UNION SELECT '321' AS aircraft_code,
                '3200' AS consmp_per_hour
   UNION SELECT '319' AS aircraft_code,
                '2600' AS consmp_per_hour
   UNION SELECT '733' AS aircraft_code,
                '2600' AS consmp_per_hour
   UNION SELECT 'CR2' AS aircraft_code,
                '1200' AS consmp_per_hour)
SELECT *
FROM
  (SELECT w_a.flight_id,
          w_a.departure_airport,
          a.city departure_city,
          date_part('hour', w_a.actual_arrival-w_a.actual_departure)*60+date_part('minute', w_a.actual_arrival-w_a.actual_departure) minutes_in_air
   FROM winter_anapa w_a
   JOIN dst_project.airports a ON w_a.departure_airport=a.airport_code) departed
JOIN
  (SELECT w_a.flight_id,
          w_a.arrival_airport,
          a.city arrival_city
   FROM winter_anapa w_a
   JOIN dst_project.airports a ON w_a.arrival_airport=a.airport_code) arrived ON departed.flight_id=arrived.flight_id
LEFT JOIN
  (SELECT w_a.flight_id,
          sum(t_f.amount)
   FROM winter_anapa w_a
   JOIN dst_project.ticket_flights t_f ON w_a.flight_id=t_f.flight_id
   GROUP BY 1) tickets_amount ON departed.flight_id=tickets_amount.flight_id
